name: Add book from issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  add-book:
    if: |
      contains(github.event.issue.labels.*.name, 'book') &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.issue.author_association)

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: "book", color: "5319e7", description: "Book ingestion issue" },
              { name: "automated", color: "adadad", description: "Automatically merge PRs" }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                });
              } catch {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ...label,
                });
              }
            }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run book ingestion
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python add_book.py

      - name: Create branch and commit
        id: commit
        run: |
          # Configure git
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Set variables
          BRANCH="book/issue-${{ github.event.issue.number }}"
          FILES="data/books.json covers"

          # Fetch latest main
          git fetch origin main

          # Checkout or reset branch from main
          git checkout -B "$BRANCH" origin/main

          # Add files
          git add $FILES || true

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Commit and push
          git commit -m "Add book from issue #${{ github.event.issue.number }}"
          git push --force origin "$BRANCH"

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create PR
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --head "book/issue-${{ github.event.issue.number }}" \
            --base main \
            --title "Add book from issue #${{ github.event.issue.number }}" \
            --body "Fixes #${{ github.event.issue.number }}" \
            --label "automated"

      - name: Enable native auto-merge
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr view --json url -q .url)
          gh pr merge "$PR_URL" --squash --auto
